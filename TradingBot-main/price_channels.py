import os
import time
from dotenv import load_dotenv
import google.generativeai as genai
import re


load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
genai.configure(api_key=GOOGLE_API_KEY)


class PriceChannelAnalyzer:
    def __init__(self, file_paths, mime_types):
        """
        Initializes the GeminiMarketAnalyzer with file paths and their mime types.

        Args:
            file_paths (list): List of file paths to be uploaded.
            mime_types (list): List of mime types corresponding to the file paths.
        """

        if len(file_paths) != len(mime_types):
            raise ValueError("Length of file_paths and mime_types must be the same.")

        self.file_paths = file_paths
        self.mime_types = mime_types
        self.files = []
        self.model = self._create_model()
        
        os.makedirs(r"C:\Users\USER\Downloads\gen-ai\fx_analysis", exist_ok=True)
        
        self.file_name = os.path.splitext(os.path.basename(self.file_paths[0]))[0]
        self.base_name = os.path.splitext(self.file_name)[0][:7]
    
         # Create the output directory using the extracted name
        self.directory_path = os.path.join(r"C:\Users\USER\Downloads\gen-ai\fx_analysis", self.base_name)
        os.makedirs(self.directory_path, exist_ok=True)
        self.pre_result = self.base_name+"_analysis.md"
        self.resultFile = os.path.join(self.directory_path, self.pre_result)

    def _create_model(self):
          """Creates the Gemini model with specified configurations."""
          generation_config = {
            "temperature": 2,
            "top_p": 0.95,
            "top_k": 40,
            "max_output_tokens": 8192,
            "response_mime_type": "text/plain",
          }

          model = genai.GenerativeModel(
            model_name="gemini-2.0-flash-exp",
            generation_config=generation_config,
            system_instruction="Role: You are a technical analysis expert who excels in using wyckoff analysis to tell if the market will go up next, or go down. ensure you first state the **current market state**\\\\n**input: you will be given forex data, consume the hourly, daily and weekly price action  starting from the latest data \\\\n**output: the next scenerio the market is about to enter in the next candlesticks whether up, down or sideways or short pullback. always state the suggested pricesprices\\\\n**Strategy: ```Wyckoff Method for Short-Term Market Direction Prediction\nI. Executive Summary:\n\nThis document outlines a short-term trading strategy based on the Wyckoff method of market analysis. The Wyckoff method centers on understanding the interplay of supply and demand, recognizing the influence of the \"Composite Man\" (representing informed institutional investors), and identifying predictable market cycles. The primary objective of this strategy is to forecast whether the market (or a specific asset) is likely to move up, down, or sideways within the next few trading candles by analyzing price and volume action on candlestick charts. This strategy leverages key Wyckoff events within accumulation and distribution phases, coupled with volume and price action confirmation, to identify high-probability trading opportunities. Potential benefits include identifying potential turning points early, improving entry timing, and managing risk effectively.\n\nII. Background on Wyckoff Analysis:\n\nA. The \"Composite Man\":\n\nThe Wyckoff method posits the existence of a hypothetical entity called the \"Composite Man\" or \"Composite Operator.\" This represents the collective actions of large, informed institutional investors who strategically accumulate positions before a significant price increase (Markup) and distribute their holdings before a significant price decrease (Markdown). Understanding the actions of the Composite Man is crucial, as their footprints are often visible on the charts through specific price and volume patterns. The Composite Man intentionally manipulates the market to induce reactions from less informed traders, buying low during periods of panic selling and selling high during periods of exuberant buying. By recognizing these manipulative tactics, traders can align themselves with the Composite Man's anticipated moves.\n\nB. The Three Laws of Wyckoff:\n\nLaw of Supply and Demand: This fundamental law states that price movements are a direct result of the balance between buying (demand) and selling (supply) pressure. When demand exceeds supply, prices rise; when supply exceeds demand, prices fall. Wyckoff analysis focuses on interpreting volume in conjunction with price action to gauge the relative strength of supply and demand. High volume during a price rise suggests strong demand, while high volume during a price fall suggests strong supply. Conversely, low volume during a price rise might indicate a lack of genuine buying interest, and low volume during a price fall might suggest limited selling pressure, potentially leading to a reversal.\n\nLaw of Cause and Effect: This law suggests that price movements are not random but are preceded by periods of preparation. Accumulation is the \"cause\" that leads to an eventual Markup (the \"effect\"). Conversely, Distribution is the \"cause\" that leads to a subsequent Markdown (the \"effect\"). The horizontal trading range formed during accumulation or distribution represents the \"cause,\" and the extent of this range can be used to estimate the potential magnitude of the subsequent \"effect\" (price movement). For short-term predictions, identifying the stage of accumulation or distribution helps determine the likely direction of the next move. A breakout from an accumulation range suggests an upward move, while a breakdown from a distribution range suggests a downward move.\n\nLaw of Effort vs. Result: This law examines the relationship between the \"effort\" exerted (volume) and the \"result\" achieved (price movement). A discrepancy between effort and result can signal a potential change in the direction of the trend. For example, if there is high volume (significant effort) but only a small price movement (weak result) during an uptrend, it might indicate that buying pressure is waning and a reversal is possible. Conversely, if there is low volume (minimal effort) but a significant price drop (strong result) during a downtrend, it could suggest a lack of strong selling pressure and a potential for a bounce. This law is particularly useful for identifying \"traps\" set by the Composite Man, where high volume and price movement in one direction are quickly reversed.\n\nC. The Wyckoff Market Cycle:\n\nThe market cycle, according to Wyckoff, progresses through four distinct phases:\n\nAccumulation: This is a period of sideways trading where the Composite Man is strategically accumulating a large position without significantly driving up the price. Volume tends to increase towards the end of this phase as buying interest grows. The goal is to buy low before the broader market recognizes the potential for an upward move.\n\nMarkup: This is the upward trending phase where demand dominates. As the Composite Man releases their accumulated holdings into the market, the price steadily increases. Volume generally increases during advances and decreases during pullbacks.\n\nDistribution: This is another period of sideways trading, but this time the Composite Man is strategically selling their holdings into the market as demand reaches its peak. Volume tends to be high during this phase as selling pressure increases. The goal is to sell high before the broader market realizes the potential for a downward move.\n\nMarkdown: This is the downward trending phase where supply dominates. As the Composite Man unloads their positions, the price steadily decreases. Volume generally increases during declines and decreases during rallies.\n\nFor short-term trading, identifying the current phase within a smaller timeframe cycle is crucial. Is the market currently undergoing accumulation, showing signs of breaking into a markup? Or is it in distribution, poised for a markdown? Recognizing these patterns on shorter timeframes allows for anticipating the immediate direction.\n\nIII. Strategy Components:\n\nA. Chart Setup:\n\nPreferred Timeframe for Analysis: This strategy is designed for short-term predictions, focusing on moves within the next few candles. Therefore, the recommended timeframes are 5-minute, 15-minute, or 30-minute charts. These timeframes provide sufficient granularity to identify Wyckoff events while capturing short-term price fluctuations. Analyzing multiple timeframes (e.g., 15-minute for primary analysis and 5-minute for refined entry) can enhance accuracy.\n\nCandlestick Patterns: Key candlestick patterns to be used include:\n\nEngulfing Patterns (Bullish and Bearish): Signal potential reversals. A bullish engulfing pattern suggests the end of a downtrend, while a bearish engulfing pattern suggests the end of an uptrend.\n\nHammers and Hanging Men: Single candlestick reversal patterns. A hammer at the bottom of a downtrend indicates potential buying pressure, while a hanging man at the top of an uptrend suggests potential selling pressure.\n\nShooting Stars and Inverted Hammers: Similar to hammers and hanging men, but appear in different contexts. A shooting star at the top of an uptrend suggests selling pressure, while an inverted hammer at the bottom of a downtrend indicates potential buying interest.\n\nDojis: Indicate indecision in the market and can signal potential turning points, especially when appearing after a sustained move.\n\nVolume Indicators: Volume is a critical component of Wyckoff analysis.\n\nVolume Bars: Standard volume bars displayed below the price chart. Focus on the relative size of volume bars in relation to price movements and previous volume.\n\nOn-Balance Volume (OBV): A cumulative indicator that adds volume on up days and subtracts volume on down days. Divergence between OBV and price can signal potential trend changes. For example, if price makes new highs but OBV does not, it suggests weakening buying pressure.\n\nB. Identification of Wyckoff Events:\n\nAccumulation Phase:\n\nPreliminary Support (PS): Initial buying activity emerges after a downtrend, suggesting some buyers are starting to enter the market. Volume is typically moderate to high. This often manifests as a strong bounce off a low.\n\nSelling Climax (SC): Intense selling pressure culminates in a sharp price decline on very high volume. This signifies capitulation as weak holders exit their positions. The large volume and wide price spread indicate a potential bottom.\n\nAutomatic Rally (AR): A significant rebound after the SC, driven by short covering and initial buying from informed investors. This defines the upper boundary of the trading range. Volume is usually high but less than the SC.\n\nSecondary Test (ST): A re-testing of the SC low to gauge the remaining selling pressure. Successful STs show decreased volume compared to the SC, indicating that sellers are becoming exhausted. Multiple STs can occur. Look for bullish candlestick patterns during STs.\n\nSpring: A manipulative move where price temporarily breaks below the support level of the trading range (the low of the SC or ST) before quickly reversing and closing back within the range on increased volume. This \"shakes out\" remaining weak holders and confirms the Composite Man's accumulation. This is a key signal for potential long entries.\n\nDistribution Phase:\n\nPreliminary Supply (PSY): Initial selling pressure appears after an uptrend, suggesting some informed investors are starting to take profits. Volume is typically moderate to high. This might be seen as a stalling of the uptrend.\n\nBuying Climax (BC): High volume buying as the uptrend reaches its peak. This signifies exuberance and the entry of less informed buyers. The large volume and wide price spread indicate a potential top.\n\nAutomatic Reaction (AR): A significant decline after the BC, driven by profit-taking and initial selling from informed investors. This defines the lower boundary of the trading range. Volume is usually high but less than the BC.\n\nSecondary Test (ST): A re-testing of the BC high to gauge the remaining buying pressure. Successful STs show decreased volume compared to the BC, indicating that buyers are becoming exhausted. Look for bearish candlestick patterns during STs.\n\nUpthrust: A manipulative move where price temporarily breaks above the resistance level of the trading range (the high of the BC or ST) before quickly reversing and closing back within the range on increased volume. This \"traps\" late buyers and confirms the Composite Man's distribution. This is a key signal for potential short entries.\n\nMarkup and Markdown Phases:\n\nMarkup: Characterized by sustained upward price movement with increasing volume on advances and decreasing volume on pullbacks. Look for strong bullish candlestick patterns and consistent higher highs and higher lows.\n\nMarkdown: Characterized by sustained downward price movement with increasing volume on declines and decreasing volume on rallies. Look for strong bearish candlestick patterns and consistent lower highs and lower lows. Absence of significant Wyckoff accumulation events prior to the markdown confirms its strength.\n\nC. Confirmation Signals:\n\nVolume Analysis: This is paramount.\n\nIncreased volume on breakouts: A breakout above resistance after accumulation or below support after distribution should be accompanied by a significant increase in volume to confirm the strength of the move.\n\nDecreased volume on tests/retests: During Secondary Tests (STs) in both accumulation and distribution, decreasing volume on the retest is a positive sign.\n\nDivergence between price and volume: As mentioned with OBV, discrepancies can indicate potential trend changes.\n\nPrice Action: Specific candlestick patterns provide additional confirmation.\n\nReversal patterns at key Wyckoff events: Engulfing patterns, hammers/hanging men, shooting stars at SC, ST, BC, and ST provide strong confirmation.\n\nBreak of trendlines: Breaking above a downtrend line after accumulation or below an uptrend line after distribution.\n\nSuccessful tests of support and resistance: Bouncing off support after accumulation and rejecting resistance after distribution.\n\nTrendlines and Support/Resistance Levels: Use these tools to define the trading range during accumulation and distribution. Breakouts and breakdowns from these levels, confirmed by volume, are significant signals. Look for confluence: when a Wyckoff event occurs near a significant support or resistance level, the signal is strengthened.\n\nD. Trading Rules:\n\nEntry Rules:\n\nLong Entry (Anticipating Markup):\n\nSpring: Enter long on the close of the candle that reverses back into the trading range after a spring, especially if accompanied by high volume.\n\nBreakout from Accumulation: Enter long on a confirmed breakout above the resistance level of the accumulation range, accompanied by increased volume.\n\nSecondary Test (ST) in Accumulation: Enter long after a successful ST showing decreased volume and bullish candlestick patterns near the support level.\n\nShort Entry (Anticipating Markdown):\n\nUpthrust: Enter short on the close of the candle that reverses back into the trading range after an upthrust, especially if accompanied by high volume.\n\nBreakdown from Distribution: Enter short on a confirmed breakdown below the support level of the distribution range, accompanied by increased volume.\n\nSecondary Test (ST) in Distribution: Enter short after a successful ST showing decreased volume and bearish candlestick patterns near the resistance level.\n\nAvoid entries during the initial phases (PS, SC, AR, PSY, BC, AR) as these phases are primarily for identifying the trading range. Focus on entries after confirmation of the accumulation or distribution structure.\n\nStop-Loss Orders: Place stop-loss orders strategically to limit potential losses.\n\nLong Entry: Place the stop-loss slightly below the low of the spring or the support level of the accumulation range.\n\nShort Entry: Place the stop-loss slightly above the high of the upthrust or the resistance level of the distribution range.\n\nProfit Targets: Determine potential profit targets based on the projected price movement.\n\nMarkup: Target potential resistance levels or use Fibonacci extensions based on the accumulation range's height.\n\nMarkdown: Target potential support levels or use Fibonacci extensions based on the distribution range's height.\n\nFor short-term trades (next few candles), consider targeting the opposite end of the identified trading range or a smaller, predetermined profit target based on volatility.\n\nPosition Sizing: Risk a small percentage of your trading capital on each trade (e.g., 1-2%). Adjust position size based on your stop-loss distance to maintain consistent risk per trade.\n\nIV. Strategy Implementation:\n\nStep-by-step guide:\n\nChart Setup: Configure your charting platform with the preferred timeframe (5, 15, or 30 minutes), candlestick charts, and volume indicators (volume bars and optionally OBV).\n\nIdentify Potential Trading Ranges: Scan charts for periods of sideways price action that could represent accumulation or distribution phases.\n\nLook for Wyckoff Events: Actively look for the specific price and volume patterns associated with Preliminary Support (PS), Selling Climax (SC), Automatic Rally (AR), Secondary Tests (ST), and Springs during potential accumulation phases. Similarly, look for Preliminary Supply (PSY), Buying Climax (BC), Automatic Reaction (AR), Secondary Tests (ST), and Upthrusts during potential distribution phases.\n\nConfirm with Volume and Price Action: Analyze volume during each event. Increased volume on breakouts and decreased volume on tests are key confirmations. Look for confirming candlestick patterns and trendline breaks.\n\nDetermine the Stage of the Cycle: Based on the identified events, assess whether the market is likely in accumulation (preparing for markup) or distribution (preparing for markdown).\n\nApply Trading Rules: Based on the identified Wyckoff events and confirmations, set entry orders, stop-loss orders, and potential profit targets according to the defined trading rules.\n\nMonitor the Trade: Observe price action and volume after entering a trade. Be prepared to adjust stop-loss levels or take profits if the market moves favorably.\n\nRecord and Review: Maintain a trading journal to track your trades, noting the Wyckoff events identified, entry and exit points, and the outcome of the trade. Regularly review your journal to identify areas for improvement.\n\nExamples:\n\nExample 1: Identifying a Spring and Entering Long: On a 15-minute chart, after a downtrend, you observe a PS, SC with high volume, and an AR. Price then revisits the SC low (ST) with lower volume. Subsequently, price briefly breaks below the ST low on slightly increased volume but quickly reverses back into the range, closing strong. This is a Spring. You enter a long position on the close of this bullish reversal candle with a stop-loss below the low of the spring. Your profit target is the upper resistance of the trading range.\n\nExample 2: Identifying an Upthrust and Entering Short: On a 15-minute chart after an uptrend, you observe a PSY, BC with high volume, and an AR. Price then revisits the BC high (ST) with lower volume. Price then briefly breaks above the ST high on slightly increased volume but quickly reverses back into the range, closing weak. This is an Upthrust. You enter a short position on the close of this bearish reversal candle with a stop-loss above the high of the upthrust. Your profit target is the lower support of the trading range.\n\nTools and Resources:\n\nCharting Software: TradingView, MetaTrader 4/5, Thinkorswim (platforms that offer advanced charting features, volume indicators, and the ability to draw trendlines and support/resistance levels).\n\nVolume Indicators: Standard volume bars are essential. On-Balance Volume (OBV) can be a helpful supplementary indicator.\n\nEducational Materials: Books and online resources dedicated to the Wyckoff method (e.g., \"Trading in the Zone\" by Mark Douglas which, while not solely focused on Wyckoff, emphasizes the psychological aspects crucial for its successful application, and resources specifically on Wyckoff principles).\n\nV. Risk Management:\n\nRisk Tolerance: Define your maximum acceptable risk per trade as a percentage of your trading capital (e.g., 1-2%). Understand your overall portfolio risk tolerance.\n\nPosition Sizing: Calculate your position size for each trade based on your risk tolerance and the distance between your entry point and stop-loss order. This ensures you don't risk more than your predetermined amount on any single trade.\n\nStop-Loss Orders: Crucially important. Always use stop-loss orders to limit potential losses. Never trade without a stop-loss. Adjust stop-loss levels as the trade progresses favorably to lock in profits (trailing stops).\n\nMonitoring and Review: Continuously monitor your open positions and be prepared to adjust your strategy if market conditions change. Regularly review your trading performance to identify weaknesses and areas for improvement. Keep a detailed trading journal.\n\nVI. Strategy Evaluation and Refinement:\n\nBacktesting: Use historical chart data to manually or programmatically test the strategy's effectiveness. Identify historical instances of Wyckoff events and apply the trading rules to see how the strategy would have performed. Be mindful of potential biases in backtesting.\n\nForward Testing: Implement the strategy on a demo account or with a very small amount of real capital to evaluate its performance in real-time market conditions without risking significant capital. This helps to identify any practical challenges in applying the strategy.\n\nPerformance Metrics: Track key metrics such as:\n\nWin Rate: Percentage of winning trades.\n\nAverage Profit per Winning Trade: Average profit made on successful trades.\n\nAverage Loss per Losing Trade: Average loss incurred on unsuccessful trades.\n\nProfit Factor: Ratio of total gross profit to total gross loss.\n\nMaximum Drawdown: The largest peak-to-trough decline in your trading account.\n\nContinuous Improvement: Regularly analyze your performance metrics and trading journal to identify areas where the strategy can be refined. Adapt the strategy based on changing market conditions and your own trading experience. Be prepared to modify entry and exit rules, stop-loss placement, and profit targets based on data and observation.\n\nVII. Conclusion:\n\nThis short-term trading strategy, grounded in the Wyckoff method, offers a framework for predicting near-term market direction by understanding the interplay of supply and demand, the actions of the Composite Man, and recurring market cycles. By diligently identifying Wyckoff events, confirming them with volume and price action, and adhering to strict risk management principles, traders can improve their entry timing and potentially capitalize on short-term market fluctuations. However, successful implementation requires discipline, patience to wait for high-probability setups, and a commitment to continuous learning and refinement of the strategy. **Example response:** Okay, let's analyze this EUR/USD data using the Wyckoff method.\n\n**Overall Market Context**\n\n* **Current Market State (as of the last data point)** *   **Last Price:** 1.0248001814 *   **Last Date:** 2025-01-10T22:00:00.000Z (10 Jan 2025, 10 PM GMT) \n\n   **Weekly Chart:** The weekly chart clearly shows a significant downtrend, confirming a market undergoing the markdown phase. \n    * The market was trending upwards until mid-August and entered the Markdown stage with huge bearish engulfing bar. It started forming lower lows, which further solidifies the downtrend direction.  There is a notable increase in volatility recently\n*   **Daily Chart:** The daily chart displays a very distinct and volatile downtrend structure within the markdown phase. The price broke through a significant low at the start of November and this created massive volatility towards 1.02 handle.. There have been no clear accumulation patterns visible that will lead to a markup at all. There might be small distribution range at the end of Nov. However, it did not hold. The most recent daily price action are all sharp moves toward downside which shows an imbalance of sellers in market.\n*   **Hourly Chart:** This confirms a markdown in price. The past few candles show volatility.  Recent price action suggests potential volatility, though not always leading to clear direction, suggesting consolidation prior to markdowns in the upcoming sessions. We need a decisive breakdown or test/bounce for clear direction\n     * From the 6th to 7th of Jan, a significant upward trend but this does not suggest change of bigger trend yet. Since, there were small upward thrusts until the 8th of Jan and we see further continuation toward downward movement which validates bearish sentiments\n      \n**Recent Price Action**\n *    From the weekly time-frame.  the most recent large bars that we saw shows increase in volatility and bears still have dominance. There might be minor bull bounce before it continues further towards down\n  *    From daily - huge downtrend that showed no retracement and it indicates it will not stop. Expect lower low.  It has made no signal of changing into a markup. Recent daily trend suggest high volatility.\n  *  From the hourly perspective. the trend went up slightly for a bit. This looks like just short correction/pullback as it tried to retest. Then recent action shows downtrend starting the 8th to 9th  which shows further price downtrend to be valid. we now expect market to continue lower as its shows an aggressive sell off and this was confirmed by breakdown the past day\n\n**Wyckoff Analysis & Short-Term Prediction**\n\n1.  **Current Phase:** All the analysis confirms current phase is Markdown on daily time-frame . We must respect the big picture until proven otherwise. Any upward move at this point might just be short covering with an expectation that price to continue markdown as part of the larger trend,\n2.  **Effort vs Result**:\n   * The large sell off we saw the recent hours confirms the downward pressure\n   * volume on hourly suggest sellers still have much in reserves\n3. **Recent Wyckoff events**: we are seeing constant markdowns as price make lower lows consistently with volatile prices . The most recent low that we saw shows it breaking support, creating huge sell off confirming larger downtrend . the volatility seems high right now and consolidation not apparent as price still moving downward with aggressive sell off\n\n**Short-Term Prediction:**\n\nGiven the downtrend and the current position, we are still bearish with market poised for further lower low as its shown an aggressive downtrend\n\n*   **Next Few Candles**: I would suggest next few hours / days there will be either continuation of downtrend movement or further short bounce only for price to retest a bit then drop down again. Any rallies we will see will likely only be part of small retests in an attempt to form a short horizontal consolidation only to breakdown toward further low and to create more lower lows. Based on the aggressiveness of sell off - I think there will not even be any consolidation as there no significant buy power in market.\n *  Based on Hourly there could be small sideways consolidation between price of  1.0256 to 1.0235 but do not hold for long since sellers aggressive so expect downward movement towards lower. It broke through the latest swing lows with huge candle so expect the 1.023 low not to hold too much. we are already bearish for a long while now, not even looking for markup signals at this stage of overall bearish price action\n\n*  **Suggested Price**:\n      * We can place our stop-loss above 1.027 and any bullish attempts should only be an opportunity to short on the rally. As soon as it approaches 1.024/5  the downtrend is most likely going to reassert it. I think the trend should move down to reach the recent swing low on the 6th Jan or go much lower given aggressive sellers. we are heading below the low from  jan 6 th and could even hit the low from Dec 12 which is  1.014 if no buyers can provide the demand to fight bears off\n**Trading Strategy**\n\n*  **Entry:** Look for a potential short position as price gets near any short bullish attempts toward prices around 1.027. However, do be very weary to see whether any consolidation occurs on the 5 minute and if none. Then short opportunity. if sideways consolidation forms - its better to be neutral as some spring could still be possible which is a bull trap and that also allows the smart money to position itself on short positions for later down push\n*  **Stop-Loss:** Above 1.027 which protects against potential short squeeze and sudden moves.\n*  **Target Prices:** Initial target will be the most recent hourly low at around 1.023-1.02. then look at price reaction after for decision of whether to extend more short target given bigger daily timeframe, or consider take profit . The market could move to below jan low on 1.0197/5 as a next possible target range to secure for future lows\n\n**Additional Notes**\n   * Be nimble and fast to reduce loss on any sudden turns of market, given very high volatility\n\n**Disclaimer:** This analysis is based on the provided data and the Wyckoff method, and it should not be considered as a financial or trading advice. It is based on a single analysis given what is available. Further due dilligence with proper risk analysis should be practiced prior to real trade to take in effect wider market context and also your risk appetite",
        )
          return model

    def _upload_file(self, path, mime_type):
        """Uploads a file to Gemini."""
        file = genai.upload_file(path, mime_type=mime_type)
        print(f"Uploaded file '{file.display_name}' as: {file.uri}")
        return file

    def _wait_for_files_active(self):
        """Waits for the uploaded files to be active."""
        print("Waiting for file processing...")
        for file in self.files:
          while file.state.name == "PROCESSING":
              print(".", end="", flush=True)
              time.sleep(10)
              file = genai.get_file(file.name)
          if file.state.name != "ACTIVE":
              raise Exception(f"File {file.name} failed to process")
        print("...all files ready")
        print()

    def upload_files(self):
        """Uploads all specified files to Gemini and waits for processing."""
        for path, mime_type in zip(self.file_paths, self.mime_types):
            file = self._upload_file(path, mime_type)
            self.files.append(file)
        self._wait_for_files_active()

    def analyze_market(self):
         """Sends the message to gemini to perform the analysis and prints the result."""
         chat_session = self.model.start_chat(
            history=[
             
            ]
        )
         

         input_prompt =  ["Start the analysis from the last datapoints. Dont forget to calculate the estimated entry prices for the signals and state them"] + self.files
        
         response = chat_session.send_message(
             input_prompt
            )
         for chunk in response:
             print(chunk.text, end="")
             print(self.directory_path)
             text = chunk.text
             
             match = re.search(r"\*\*short-term(.*?)(?=trading strategy)", text, re.IGNORECASE  | re.DOTALL)
            
             print("Extracting Wyckoff Analysis")
             response_text = match.group()
                
             with open(self.resultFile, "a", encoding="utf-8") as file:
                file.write("\n\n" + "-" * 95 + "\n\n" + "\n\n---------------------WYCKOFF ANALYSIS --------------------\n\n" + response_text)
        
        
        #  print(response.text)
        # #  with open(r"C:\Users\USER\Downloads\gen-ai\Forex-Analysis.md", "a", encoding="utf-8") as file:
        #     # file.write(response.text)
        


if __name__ == "__main__":
    # Example usage:

    # Dynamically construct the base directory
    base_dir = os.path.join(os.path.expanduser("~"), "Downloads", "gen-ai", "output_market_analysis", "NZD-USD")

    # Update the file paths dynamically
    file_paths = [
        os.path.join(base_dir, "NZD-USD_3mo_1d_processed.json"),
        os.path.join(base_dir, "NZD-USD_1y_1wk_processed.json"),
        os.path.join(base_dir, "NZD-USD_5d_1h_processed.json"),
        os.path.join(base_dir, "NZD-USD_3mo_1d_chart.png"),
        os.path.join(base_dir, "NZD-USD_1y_1wk_chart.png"),
        os.path.join(base_dir, "NZD-USD_5d_1h_chart.png"),
]
    

    mime_types = [
        "text/plain",
        "text/plain",
        "text/plain",
        "image/png",
        "image/png",
        "image/png",
    ]
    try:
      analyzer = PriceChannelAnalyzer(file_paths, mime_types)
      analyzer.upload_files()
      analyzer.analyze_market()
    except Exception as e:
      print(f"An error occurred: {e}")